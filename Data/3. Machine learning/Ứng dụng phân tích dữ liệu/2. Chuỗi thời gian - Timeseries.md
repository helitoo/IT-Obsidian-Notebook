
```insta-toc
---
title:
  name: Mục lục
  level: 1
  center: false
exclude: ""
style:
  listType: number
omit: []
levels:
  min: 1
  max: 6
---

# Mục lục

1. Tổng quan
2. Dự báo chuỗi thời gian (Timeseries analysis, TSA)
    1. Mô hình phân tách
    2. Phân rã timeseries
3. Các kỹ thuật thường dùng để phân tích timeseries
    1. Phát hiện outlier
        1. Dùng line-plot
        2. Dùng box-plot
    2. Phát hiện seasonality và cycle
    3. Xử lý dữ liệu khuyết
    4. Trung bình mượt
    5. Loại bỏ yếu tố trend (Detrended)
```

# Tổng quan

**Chuỗi thời gian (Timeseries)** là một chuỗi các điểm dữ liệu xảy ra theo thứ tự liên tiếp trong một khoảng thời gian (*Regular timeinterval*), gắn chặt với thời gian.

>[!important]
>Các mốc dữ liệu trong timeseries **phải cách đều đặn nhau một khoảng thời gian cố định**. Nếu có điểm khuyết, ta phải tìm cách khắc phục.

Ứng dụng của chuỗi thời gian trải khắp các ngành công nghiệp khác nhau như:
- Quan sát hoạt động sóng điện trong não.
- Đo lượng mưa.
- Dự báo giá cổ phiếu.
- Theo dõi doanh số bán lẻ hàng năm.
- Người đăng ký hàng tháng...

# Dự báo chuỗi thời gian (Timeseries analysis, TSA)

Dự báo chuỗi thời gian là các kỹ thuật dự đoán các sự kiện trong tương lai thông qua chuỗi thời, với giả định rằng các xu hướng trong tương lai sẽ tương tự như những gì từng xảy ra.

**Những vấn đề cần lưu ý khi dự báo chuỗi thời gian**:
1. Càng nhiều dữ liệu sẵn có, càng tốt
2. Dự đoán trong khoảng thời gian càng ngắn thì càng dễ.
3. Cần cập nhật dự báo thường xuyên.

Dữ liệu timeseries có 2 kiểu:
1. **Stationary**: Trend ổn định theo thời gian.
2. **Non-stationary**: Ngược lại.

![](https://www.researchgate.net/publication/372517696/figure/fig2/AS:11431281176093922@1690016354016/Stationary-and-non-stationary-time-series-A-time-series-stationary-or-non-stationary.png)

Chỉ có dữ liệu stationary mới khả thi để phân tích. Người ta thường dùng [[2. Chuỗi thời gian - Timeseries#Loại bỏ yếu tố trend (Detrended)|dùng đạo hàm để loại bỏ trend]].

## Mô hình phân tách

Chuỗi thời gian ban đầu có thể được phân tách thành các **chuỗi thời gian thành phần**, sau đó dựa trên chuỗi này để mô tả.

Gồm có:
1. **Long-term movement / Trend** ($T_t$): Chỉ ra xu hướng tổng thể của dữ liệu: *Lên - Xuống, Tăng - Giảm,...*.
2. **Short-term movement**: Chỉ ra xu hướng trong một giai đoạn trong một khoảng thời gian. Gồm có 2 dạng:
	1. **Seasonality** $S_t$: Sự lặp đi lặp lại của dữ liệu, mỗi sự lặp lại thì vừa khít trong một khoảng thời gian cố định.
	2. **Cycle** ($C_t$): Cũng là sự lặp đi lặp lại, nhưng mỗi chu kỳ không nhất thiết phải diễn ra trong một khoảng thời gian cố định.
3. $e_t$: **Irregular movement / Noise** ($I_t$): Các yếu tố nhiễu.


![](https://machinelearningcoban.com/tabml_book/_images/timeseries_data_25_0.png)

## Phân rã timeseries

| Mô hình cộng tính                                                                                                                      | Mô hình nhân tính                                                                                                         |
| -------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------- |
| Phù hợp với các chuỗi biến động ổn định, ta không thể nhìn thấy rõ biên độ dao động của nó trong tương lai.<br>$$Y_t=T_t+S_t+C_t+I_t$$ | Do là gia tăng theo phép nhấn nên càng theo thời gian thì độ biến động của chuỗi sẽ càng mạnh.<br>$$Y_t=T_t*S_t*C_t*I_t$$ |

![](https://machinelearningcoban.com/tabml_book/_images/timeseries_data_23_0.png)

# Các kỹ thuật thường dùng để phân tích timeseries

## Phát hiện outlier

### Dùng line-plot

Cho một bộ dữ liệu về doanh số dầu gội (*Shampoo revenue*) trong 36 tháng như sau:

![](https://machinelearningcoban.com/tabml_book/_images/timeseries_data_3_0.png)

Nhìn vào biểu đồ trên ta có thể phát hiện ra dữ liệu vào tháng 05-2002 là outlier vì giá trị của nó vượt xa so với những điểm xung quanh và nằm ra ngoài xu hướng của chuỗi.

### Dùng box-plot

Ngoài ra, ta có thể dùng biểu đồ **box-plot** để phát hiện outlier.

Biểu đồ box-plot có các ngowngx chia là:
- $Q_1$: Mức phân vị 25%.
- $Q_2$: Mức phân vị 50%, cũng là median.
- $Q_3$: Mức phân vị 75%.

Từ đó phân chia ra thành các miền giá trị là:
- $x<Q_1$: Miền giá trị thấp nhất.
- $x\in[Q_1,Q_2)$: Miền giá trị thấp.
- $x\in[Q_2,Q_3)$: Miền giá trị cao.
- $x\geq Q_3$: Miền giá trị cao nhất.

**Interquartile range (IQR)** là khoảng giữa $Q_3$ và $Q_1$, tức là miền giá trị thấp đến cao.
$$IQR=Q_3-Q_1$$
Điểm $x$ là outlier khi:
$$
\left[
\begin{align}
x&<Q_1-1.5*IQR\\
x&>Q_3-1.5*IQR
\end{align}
\right.
$$

![](https://machinelearningcoban.com/tabml_book/_images/timeseries_data_7_0.png)

Ta thấy có 2 điểm outlier vượt ra khỏi râu của box-plot.
Tìm 2 outlier đó:
```python
import numpy as np

def detect_outliers(series):
  Q1 = np.quantile(series, 0.25)
  Q3 = np.quantile(series, 0.75)
  IQR = Q3-Q1
  lower_bound = Q1-1.5*IQR
  upper_bound = Q3+1.5*IQR
  
  lower_compare = series <= lower_bound
  upper_compare = series >= upper_bound
  
  outlier_idxs = np.where(lower_compare | upper_compare)[0]
  return outlier_idxs

outlier_idxs = detect_outliers(diff_sales)

print("Outlier indices: ", outlier_idxs)
print("Outlier months: ", df.index[outlier_idxs+1].values)
print("Outlier values: ", diff_sales[outlier_idxs])
```
```sh
Outlier indices:  [15 16]
Outlier months:  ['2002-05-01T00:00:00.000000000' '2002-06-01T00:00:00.000000000']
Outlier values:  [ 418.1 -404.4]
```

Như vậy các tháng 05/2002 và 06/2002 là những tháng xuất hiện outliers.

## Phát hiện seasonality và cycle

Đối với phương pháp định lượng chúng ta có thể dựa trên **hệ số tự tương quan**.

![](https://imgur.com/zhl44t8.png)

Trong đó:
- Trục trung đại diện cho hệ số tương quan.
- Trục hoành đại diện cho độ trễ.
- Mỗi một mốc giá trị là một hệ số tương quan trễ, có công thức:
$$p(l)=\frac{cov(x_t,\;x_{t-l})}{\sqrt{\sigma_t.\sigma_{t-l}}}$$
Trong đó:
- $l$: Độ trễ.
- $x_{t-l}$: Giá trị trễ của chuỗi $x_t$.

Nếu có quy luật seasonality với cycle $s$ thì hệ số tương quan theo độ trễ tại các điểm $s$, $2s$, $3s$,... sẽ lớn hơn so với các điểm xung quanh.

Trong trường hợp trên, ta thấy có cycle $s=4$.

## Xử lý dữ liệu khuyết

Có 2 phương pháp là **nội suy tuyến tính (interpolate)** và **ngoại suy tuyến tính (extrapolate)**.

| Phương pháp nội suy được dùng khi điểm khuyết nằm giữa các điểm khác:<br>![](https://imgur.com/bdqmTzO.png) | Phương pháp ngoại suy được dùng khi điểm khuyết ở các trường hợp còn lại:<br>![](https://imgur.com/RqGuPoF.png)<br> |
| ----------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------- |

## Trung bình mượt

Trung bình trượt là phương pháp **làm mịn chuỗi** bằng cách **lấy trung bình** của chuỗi trong một khung thời gian.

**Ý nghĩa**: Theo dõi giao động trong ngắn hạn và nhận biết được xu hướng trong dài hạn của chuỗi.

Có 2 phương pháp:

| **Trung bình mượt đơn (SMA)**<br>                                                                                                         | **Trung bình mượt cấp số nhân (EMA)**                                                                                                                                                  |
| ----------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Là trung bình cộng của $n$ mốc dữ liệu liền kề nhau. Phản ứng chậm với thay đổi của điểm dữ liệu vì các điểm được đánh trọng số như nhau. | Cũng giống SMA nhưng các điểm càng gần thời điểm $t$ thì có trọng số cao hơn. Do đó, mô hình này mô tả trend tốt hơn so với SMA.                                                       |
| $$\text{SMA}_t=\frac{\sum_{i=t-n}^tx_i}{n}$$<br>	![](https://machinelearningcoban.com/tabml_book/_images/timeseries_data_17_0.png)        | $$\text{EMA}_t=\alpha+x_t+(1-\alpha).\text{EMA}_{t-1}$$Trong đó:<br>$$\alpha=\frac{2}{n+1}$$<br>	<br>![](https://machinelearningcoban.com/tabml_book/_images/timeseries_data_19_0.png) |

## Loại bỏ yếu tố trend (Detrended)

Yếu tố trend có thể vô tình tạo ra sự tương quan tuyến tính "ảo". Ta có thể loại bỏ nó bằng công thức:
$$x'_t=x_t-\alpha t$$
Trong đó:
- $x'_t$: Điểm dữ liệu sau khi loại bỏ trend.
- $x_t$: Điểm dữ liệu tại $t$.
- $\alpha t$: Thành phần trend. $\alpha$ có thể được ước lượng thông qua hồi quy tuyến tính giữa $x_t$ bà $t$.

![](https://machinelearningcoban.com/tabml_book/_images/timeseries_data_21_0.png)
















