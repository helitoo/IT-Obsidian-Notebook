
```insta-toc
---
title:
  name: Mục lục
  level: 1
  center: false
exclude: ""
style:
  listType: number
omit: []
levels:
  min: 1
  max: 6
---

# Mục lục

1. Server rendering
    1. Prefetching
    2. Client-side transition
    3. Một số lý do làm giảm hiệu năng transition
2. Quy trình rendering của Next.js
```

**Tài liệu tham khảo**:
- [Next.js | Linking and Navigating](https://nextjs.org/docs/app/getting-started/linking-and-navigating).

# Server rendering

Trong Next.js, component được chia thành 2 loại:

|                                     | Server component                   | Client component                                                                                |
| ----------------------------------- | ---------------------------------- | ----------------------------------------------------------------------------------------------- |
| **Là:**                             | Component được render bởi *server* | Component được render một phần bởi *server*, và render vài lần nữa tại *client* cho hoàn thiện. |
| **Directive**<br>(*Đặt ở đầu file*) | `'use server'`<br>\[Mặc định]      | `'use client'`                                                                                  |
| **Dùng khi nào?**                   |                                    | - Cần theo dõi tương tác với người dùng: *Hook, Event handler,...*<br>- Cần đợi fetch API.      |

Có 2 loại rendering (SSR):
- **Static rendering (Prerendering)**: Xảy ra khi build hoặc khi caching and revalidating.
- **Dynamic rendering**: Xảy ra khi server nhận được request từ client.

Đối với SSR thông thường, độ trễ của việc gửi request và nhận response sẽ làm giảm UX. Next.js đã khắc phục chúng bằng cơ chế **prefetching routes** và **client-side transitions**.

## Prefetching

Prefetching tức là **tải route nền trước khi client điều hướng tới nó**. Tức là khi client click vào link điều hướng, nội dung của nó đã được load sẵn rồi.

Số lượng route được prefetching phụ thuộc vào việc nó là static hay dynamic:
- **Static route**: *Toàn bộ* routes con sẽ được prefetching.
- **Dynamic route**: Chỉ có thể được prefetching *một phần* nếu dev khai báo `loading.tsx` (cơ chế **streaming**).

## Client-side transition

Việc SSR sẽ vô tình **tải lại toàn bộ trang**, reset các state, scroll position, blocks interactivity,...

Next.js khắc phục điều này bằng cơ chế **transition**:
- Giữ lại tất cả nội dung không thay đổi trên trang.
- Thay thế trang hiện có bằng prefetching hoặc nội dung mới (nếu có).

*Client-side transition* khiến cho UX trông giống như CSR, thực tế nó là SSR.

## Một số lý do làm giảm hiệu năng transition

1. **Dynamic route không có `loading.tsx`**: Client buộc phải đợi cho đến khi route tải xong, không tận dụng được Next.js streaming.

2. **Dynamic route không có `generateStaticParams`**: Route sẽ chuyển sang dynamic tại thời điểm nó được request.

3. **Mạng chậm**: Khi mạng chậm thì prefetching cũng không có ý nghĩa gì mấy. Trong trường hợp này, bạn có thể dùng **hook `useLinkStatus`** để tạm đóng vai trò như `loading.tsx` (*thông báo cho client biết đang load*).

4. **Prefetching bị vô hiệu**: Prefetching toàn bộ không phải là một ý tưởng hay vì nó sẽ làm giảm bộ nhớ, ta chỉ nên prefetching một số route mà client thường đến nhất.

5. **Hydration chưa xong**: Các client component (bao gồm `<Link>`) phải được **hydrated** (*kích hoạt, nối kết mã JS trên browser với HTML tĩnh đã được render từ server*) trước khi có thể bắt đầu prefetching. Trong lần truy cập đầu tiên, nếu bundle JS quá lớn, quá trình hydration có thể bị trì hoãn, khiến cho prefetching không thể bắt đầu ngay lập tức. React có cơ chế **Selective Hydration (Hydration chọn lọc)** để giảm bớt vấn đề này. Ngoài ra, bạn có thể tối ưu thêm bằng cách:
	1. Sử dụng plugin `@next/bundle-analyzer` để xác định và giảm kích thước bundle, bằng cách loại bỏ hoặc tách các thư viện nặng không cần thiết.
	2. Chuyển bớt logic từ phía client sang phía server nếu có thể.

# Quy trình rendering của Next.js

**Khi request lần đầu (Full page load)**:
1. Server Next.js render các Server component và kết hợp với các Client component để tạo ra HTML gửi về client. Các Client component được render dựa trên **React server component (RSC) payload**.
2. **Hydration**: Gắn các JS vào HTML.

**Khi request các lần sau (Subrequest navigation)**:
1. Server chỉ gửi về các RSC payload, CSS, JS *cần thiết*.
