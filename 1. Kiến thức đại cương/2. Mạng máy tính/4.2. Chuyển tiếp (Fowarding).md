
# Router

## Cấu trúc

Router gồm các thành phần:

| Input ports                                                                                                                                                   | Output Ports                                                                                                                                                                                 |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Line termination**: Nhận tín hiệu vật lý.                                                                                                                   | **Line terminator**: Gửi tín hiệu vật lý.                                                                                                                                                    |
| **Link layer protocol**: Đóng gói frame.                                                                                                                      | **Link layer protocol**: Phân mảnh frame:                                                                                                                                                    |
| **Datagram buffer**:<br>- Nếu fabric không kịp, đưa gói vào queue ở input.<br>- Có thể bị Head-of-the-Line (HOL) blocking: gói đầu tiên chặn các gói sau.<br> | **Datagram buffer**:<br>- Là hàng đợi của output.<br>- Loại bỏ (drop) gói tin nếu bộ đệm đầy (Buffer overflow).<br>- Đánh dấu các gói có khả năng gây tắc nghẽn.<br>- Định thời gửi gói tin. |
| **Lookup forwarding**: Tra cứu bảng forwarding để tìm cổng đầu ra. \[Giới thiệu sau].                                                                         |                                                                                                                                                                                              |

Ngoài ra, switch còn 2 thành phần sau:

**Switching Fabric**:
- Là thành phần *xương sống* kết nối input ports và output ports.
- Quyết định *tốc độ chuyển đổi (switching)*, được đo bằng bội số của tốc độ vào / ra của cổng vào / ra.
- Có 3 loại fabric:

| Memory \[Lỗi thời]                                                             | Bus                                                                                                            | Interconnection network \[Hiện đại]                                                                                                                                                                                                                                                              |
| ------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Gói tin được sao chép vào bộ nhớ hệ thống, được **CPU chuyển tiếp trực tiếp**. | Các gói được truyền trong **1 bus chung**. *Tại 1 thời điểm chỉ có 1 gói được qua bus*, các gói khác phải chờ. | Các gói được **truyền song song**.<br><br>Gồm có các dạng:<br>- **Crossbar / Clos**: Xây dựng *lưới circuit* kết nối các cổng, gói tin sẽ đi dọc theo các circuit để đến đích.<br>- **Switch đa tầng**: Fabric được chia thành *nhiều fabric nhỏ*, các gói truyền qua các fabric nhỏ trung gian. |
| Tốc độ phụ thuộc vào tốc độ băng thông bộ nhớ (tốn 2 bus).                     | Tốc độ phụ thuộc vào tốc độ băng thông bus (*tranh chấp bus*).                                                 | Tốc độ cao.                                                                                                                                                                                                                                                                                      |

**Routing Processor (Bộ xử lý chuyển tiếp)**: Nơi chạy *control plane* (các thuật toán định tuyến, quản lý).

## Cơ chế forward của cổng đầu vào

Forwarding dựa trên **bảng chuyển tiếp (Forward table)**.

Có 3 cách forward:
1. **Destination-based forwarding** \[Truyền thống]: Tra cứu theo địa chỉ IP đích.
2. **Longest prefix matching**: Giống phương pháp trên nhưng không cần khớp IP đích 100% mà chỉ cần so khớp phần tiền tố dài nhất.
3. **Generalized forwarding**: Tra cứu theo bất kỳ trường header nào (SDN kiểu match-action).

## Cơ chế quản lý hàng đợi

Bộ nhớ đệm được dùng như là queue để đưa các gói vào.

Kích thước bộ nhớ đệm:
- Theo quy tắc ngón tay cái RFC 3439:
$$\text{Buffer size}\leq\text{Bandwith}\times\text{RTT}$$
- Công thức cải tiến: Với $N$ là số luồng đồng thời qua liên kết thì:
$$\text{Buffer size}=\frac{\text{Bandwith}\times\text{RTT}}{\sqrt{\text{Number of flow}}} $$

>[!important]
>- Quá ít bộ nhớ đệm -> Mất gói.
>- Quá nhiều bộ nhớ đệm -> Tăng độ trễ.
>- RTT dài -> Gây trễ, Hiệu suất kém.

Các chiến lược quản lý bộ nhớ đệm:
1. **Drop-tail**: Bỏ gói đến khi bộ đệm đầy.
2. **Priority drop**: Loại gói theo mức ưu tiên.
3. **Marking**: Gắn cờ (RED, ECN) để báo hiệu tắc nghẽn thay vì drop ngay.

## Các chiến lược Định thời gửi gói của cổng đầu ra

Có 3 phương pháp định thời:
1. **FCFS/FIFO**: Gói đến trước thì được gửi đi trước.
2. **Priority queuing**: Gói có mức độ ưu tiên cao thì được gửi trước.
3. **Round Robin (RR)**: Phân bổ các gói vào hàng đợi riêng, định thời luân phiên giữa các hàng đợi.
4. **Weighted Fair Queuing (WFQ)**: Phân bổ băng thông theo trọng số (công bằng nhưng có thể ưu tiên).

## Tính trung lập của mạng

**Về mặt kỹ thuật**: Router không phân biệt traffic "theo ý riêng" (VD ưu tiên YouTube hơn Netflix).

**Về mặt xã hội**: Bảo vệ tự do ngôn luận, cạnh tranh công bằng.

Mỗi quốc gia có quan điểm khác nhau về trung lập mạng.

# Phân mảnh và Tổng hợp IP

Các đường link mạng đều có kích thước truyền tin tối đa (**Max transfer size - MTU**). Mỗi đường link có MTU khác nhau.
- **Phân mảnh**: Datagram bị router gửi chia ra thành nhiều gói nhỏ hơn rồi mới đưa lên link.
- **Tổng hợp**: Router nhận các gói nhỏ rồi ghép lại thành gói lớn.

Các trường / cờ dùng trong phân mảnh và tổng hợp:
- `length`: Tổng độ dài các gói con bằng gói cha.
- `identifier`: ID của các gói con và cha giống nhau.
- `fragment flag`: Chỉ có *gói cha và gói con cuối cùng* mới được bật là `0`.
- `offset`: Thể hiện thứ tự gói con, $\boxed{\text{offset}_i=i\times\frac{\text{MTU}-20}{8}}$ (0-based, bytes).

Tổng số gói con được tạo ra:
$$\boxed{n=\lceil\frac{\text{length}-20}{\text{MTU}}\rceil}$$

>[!important]
>- *Tổng hợp* chỉ xảy ra khi đến **router đích**.
>- Độ dài gói tin bao gồm **payload và 20 bytes header**.

























