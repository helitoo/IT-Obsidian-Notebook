
# Giới thiệu DNS

**DNS** là hệ thống chuyển đổi giữa *địa chỉ IP* và *tên miền*.

# Cấu trúc DNS

DNS gồm 2 thành phần chính:
1. 1 **Cơ sở dữ liệu phân tán** được cài đặt dưới dạng một hệ thống phân cấp các DNS server. Có hàng ngàn DNS server phân tán toàn cầu.
2. 1 **Giao thức application layer** cho phép host gửi truy vấn đến cơ sở dữ liệu.

>[!question] Tại sao không tập trung hóa hệ thống DNS?
>1. **Single point of failure**: Server sập là Internet “sập” theo.
>2. **Traffic overload**: Phải xử lý hàng tỷ truy vấn, gây áp lực lên server.
>3. **Khoảng cách địa lý xa xôi**: Nếu server ở Mỹ, thì client ở Úc phải đi nửa vòng Trái Đất.
>4. **Bảo trì phức tạp**: Cơ sở dữ liệu khổng lồ, phải cập nhật liên tục khi có host mới.

## Mạng lưới DNS servers

DNS có 3 lớp server chính và 1 lớp server phụ:

| Lớp server                                                            | Mô tả                                                                                                          | Nhiệm vụ                                                                         |
| --------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------- |
| **Root server**<br>*(Server gốc)*                                     | Thực chất là **13 hệ thống root** được nhân bản thành hơn 100 server, do 12 tổ chức quản lý (ICANN điều phối). | - Trả về địa chỉ **TLP server**.<br>- Cung cấp bảo mật **DNSSEC**.               |
| **Top-level domain (TLD) server**<br>(*Server tên miền cấp cao nhất*) | - Quản lý theo phần mở rộng tên miền (TLD): `.com`, `.org`, `.edu`, `.gov`,...                                 | - Trả về **địa chỉ authoritative servers** cho domain cụ thể (như `amazon.com`). |
| **Authoritative server**<br>(*Server có thẩm quyền*)                  | Do từng tổ chức (*trường đại học, công ty,…*) quản lý.                                                         |                                                                                  |
| **Local server**<br>(*Server cục bộ*)                                 | Do *ISP (Internet Service Provider)* cung cấp cho người dùng khi kết nối mạng (qua DHCP).                      |                                                                                  |

## Cấu trúc cơ sở dữ liệu DNS

**Bản ghi (Resource Record, RR)**: Gồm có 4 thành phần là *TTL, Type, Name, Value*.

1. **TTL (Time to live)**: Thời gian giữ bản ghi tại cache.
2. **Type**: Loại bản ghi:

| Type    | Name     | Value      | Dùng khi                                                                              |
| ------- | -------- | ---------- | ------------------------------------------------------------------------------------- |
| `NS`    | Domain   | Hostname   | Muốn xác định Authoritative server.                                                   |
| `A`     | Hostname | Địa chỉ IP | Client gõ domain<br>-> Trả về `A`.                                                    |
| `CNAME` | Alias    | Hostname   | Client gõ domain alias<br>-> Trả về `CNAME` để chuyển hướng sang domain thật.         |
| `MX`    | Alias    | Hostname   | -> Client gõ địa chỉ mail<br>-> Trả về `MX` để chuyển hướng sang địa chỉ mail server. |

**Message**: Có 2 loại là **Query** và **Reply**. Cả 2 đều có cùng định dạng gồm 5 phần:
1. **Header**: Gồm có:
	1. **ID**: Mã định danh message.
	2. **Flag**: Cờ trạng thái của message.
		1. `query/reply`: `0` = query, `1` = reply.
		2. `authoritative`: Đánh dấu khi gặp Authoritative DNS servers.
		3. `recursion desired`: Client yêu cầu server tiếp tục truy vấn đến phân cấp server tiếp theo.
		4. `recursion available`: Server thông báo có hỗ trợ truy vấn đến phân cấp server tiếp theo.
2. **Question section**: Thông tin truy vấn (*Name, Value*).
3. **Answer section**: Kết quả truy vấn (*Name, Value*).
4. **Authority section**: Danh sách các Authoritative server.
5. **Addition section**: Ghi chú.

Đối với các message nhỏ, DNS dùng **UDP 53**, ngược lại thì dùng **TCP 53**.

# Quy trình truy vấn và phản hồi

![](https://www-net.cs.umass.edu/kurose_ross/interactive/dns_query.png)

Quy trình tra cứu gồm 2 bước chính, thể hiện 2 tính chất:
1. **Truy vấn đệ quy (Recursive query)**:
	- Host sẽ tra cứu tuần tự ở **Local -> Root -> TLD -> Authoritative** (*đẩy trách nhiệm phân giải tên cho server tên miền được hỏi*).
2. **Truy vấn tuần tự (Iterative query)**: (*best practice*)
	- Sau khi nhận được query, các server sẽ kiểm tra. Nếu biết doamin này ứng với địa chỉ IP nào thì sẽ gửi về, không thì sẽ gửi địa chỉ ở server cấp tiếp theo để gửi query tiếp.
	- Do authoritative server chứa bản ghi ánh xạ IP và domain nên luôn có kết quả mà requesting host cần tìm.
3. **Cache**:
	- Trong quá trình phản hồi kết quả truy vấn, các server lưu lại bản ghi ánh xạ domain và địa chỉ IP để tiện cho lần truy vấn tiếp theo.
	- Dữ liệu trong cache sẽ chỉ tồn tại trong một khoảng thời gian **TTL (Time-to-Live)**.

>[!note]
>Mỗi request có thể truy vấn **nhiều bản ghi**.
>Nhưng trên thực tế thì hầu hết các hệ thống chỉ phản hồi 1 bản ghi cho truy vấn đầu tiên mỗi request.

# Tấn công DNS

1. Tấn công root server, TLD server bằng lưu lượng truy cập -> Lọc lưu lượng, dùng local server.
2. Chặn truy vấn DNS, gửi về response sai lệch -> **DNSSEC**.

# Quy trình chèn thêm bản ghi vào cơ sở dữ liệu

1. Đăng ký tên miền với nhà đăng ký (registra) chính thức, bao gồm cung cấp tên miền  và địa chỉ IP của authoritative server.
2. Registra đưa vào TLD server bản ghi loại `NS` và `A` / `MX`.



















