
# Giới thiệu

Bộ nhớ ảo là một kỹ thuật cho phép **xử lý 1 process mà không cần nạp toàn bộ vào bộ nhớ vật lý** -> **giảm thời gian truy xuất bộ nhớ**.

**Ưu điểm**:
- Số lượng process trong bộ nhớ nhiều hơn.
- Process có thể dùng nhiều bộ nhớ hơn bộ nhớ vật lý của nó -> Tăng **đa chương** -> Tăng số lượng process.
- Giảm nhẹ công việc của dev. Dev chỉ cần quan tâm đến logical address.

**Nhược điểm**:
- **Chậm** hơn bộ nhớ vật lý do không được truy xuất thẳng địa chỉ vật lý mà phải thông qua các trang.

>[!note] Với công nghệ bộ nhớ ảo
>Kích thước của process có thể **linh động thay đổi**, **không phụ thuộc vào phần cứng** nữa.

# Cài đặt bộ nhớ ảo

Có 2 kỹ thuật:
- **Phân trang theo yêu cầu (Demand Paging)**:
	- Các trang của process *chỉ được nạp vào bộ nhớ chính khi được yêu cầu*.
	- => Cần phải truy xuất bộ nhớ nhiều lần -> *Tốn thời gian*.
	- Khi **trang không tồn tại (Invalid bit)** -> Phần cứng gửi tín hiệu ngắt (**page-fault trap**) -> kích hoạt **page-fault service routine (PFSR)**.
	- **Các bước của PFSR**:
		1. Đưa process về **blocked / waiting**.
		2. Tìm frame trống (*trong bước này thì các process khác vẫn có thể được cấp CPU để thực thi*):
			1. Nếu tìm thấy, cập nhật lại page table, đưa process vào **ready**.
			2. Nếu không tìm thấy (*Lỗi trang, Page fault*), dùng thuật toán thay trang nhớ để thay 1 trang (**victim page**) cho process này. Một số *giải thuật thay trang*:
				1. **FIFO (First-in First-out)**: Thay thế trang **đã được dùng** sớm nhất. Có thể gây ra **nghịch lý Belady**: Càng cấp nhiều frame, page fault càng tăng.
				2. **LRU (Least Recently Used)**: Thay thế trang **hiện chưa dùng** lâu nhất.
				3. **OPT (Optimal)**: Thay thế trang **dự định** sẽ dùng xa nhất hoặc không dùng nữa.
				Sau đó cấp page (nạp trang vào bộ nhớ phụ), process chuyển về **ready**.
	
- **Phân đoạn theo yêu cầu (Demand Segmentation)**.

Mục tiêu tối thượng của các kỹ thuật trên đều là **giảm page-fault về nhỏ nhất**.

>[!note] Chú ý phân biệt với các kỹ thuật Placement của Dynamic partitioning
>1. **Best-fit**: Chọn khối trống **nhỏ nhất**.
>2. **Worst-fit**: Chọn khối trống **lớn nhất**.
>3. **First-fit**: Chọn khối trống **đầu tiên** có thể cấp phát.
>4. **Next-fit**: Chọn khối trống **đầu tiên** có thể cấp phát **tính từ vị trí khối được cấp phát cuối cùng**.

# Cấp phát frame

OS phải quyết định cấp cho mỗi process bao nhiêu frame.
- Cấp ít frame -> nhiều page fault.
- Cấp nhiều frame -> Giảm mức độ multiprogramming.

Có 2 chiến lược cấp phát frame:
1. **Cấp phát tĩnh (fixed-allocation)**:
	- Số frame cấp cho mỗi process không đổi, được xác định vào thời điểm **loading (nạp process vào bộ nhớ)** và tùy thuộc vào từng ứng dụng (kích thước của nó,...).
	- Có 2 loại cấp phát tĩnh là : Cấp phát *theo tỷ lệ* và *theo độ ưu tiên*.

2. **Cấp phát động (variable-allocation)**:
	- Số frame cấp cho mỗi process có thể thay đổi trong khi nó chạy:
		- Nếu tỷ lệ page-fault *cao* -> cấp *thêm* frame.
		- Nếu tỷ lệ page-fault *thấp* -> giảm *bớt* frame.
	- => OS phải *mất chi phí* để ước định các process.

>[!note] Ưu và nhược điểm của việc cấp phát nhiều frame
>- Cấp nhiều frame -> Có ít process được cấp frame hơn -> **Giảm đa chương**.
>- **Nghịch lý Belady (FIFO)**: Càng cấp nhiều, càng dễ page-fault.

# Vấn đề Thrashing

Thrashing là hiện tượng xảy ra khi **số lượng frame ==quá ít==** -> **giảm hit ratio** -> **máy tính tốn thời gian mapping giữa page và frame** -> **phải hoán đổi liên tục các trang nhớ**, thay vì thực thi chương trình.

Thrashing có thể gây ra **page-fault**.

Để hạn chế thrashing, OS phải cung cấp cho process càng "đủ" frame càng tốt. "Đủ" tức là phải **Xác định số frame / page mà process thực sự dùng**.

**Có 2 cơ chế nhận diện thrashing**:
- **Locality**: Đối chiếu với tập các trang được tham chiếu **gần nhau**.
- **Working set**: Đối chiếu với tập các trang được sử dụng **gần đây**, dựa trên nguyên lý của locality. Working set có thể *xấp xỉ* locality.

-> Thrasing sẽ xảy ra khi **số lượng trang NHỎ HƠN kích thước locality set / working set**.

**Giải pháp khắc phục thrashing**:
- Khi đạt ngưỡng thrashing, OS sẽ **block 1 số process** cho đến khi không thrashing.
- Cấp thêm frame.
