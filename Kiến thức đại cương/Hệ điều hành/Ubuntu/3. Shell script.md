
# Giới thiệu

## Các phương pháp lập trình bằng Shell

[[1. Giới thiệu & Cài đặt Ubuntu trên máy ảo VMWare#Shell|Shell]] có thể được sử dụng như một ngôn ngữ lập trình. Có 2 cách để viết chương trình điều khiển Shell.
1. Cách thứ nhất là gõ chương trình ngay từ dòng lệnh.
2. Gộp các lệnh vào một file để chạy. Bài viết chỉ hướng dẫn hướng đi này.

## Cấu trúc script


>[!NOTE]
>**Các bước thực hành**:
>1. Dùng `cat > urFileName.sh` để soạn thảo script ngay trong Terminal.
>2. Nhấn `Ctrl D` để kết thúc soạn thảo và lưu file.
>3. Cấp quyền thực thi: `chmod +x urFileName.sh`.
>4. Thực thi file: `./urFileName.sh`.

Các lệnh có thể được gọi là **script**. File script có đuôi `.sh`.

**Bắt đầu bằng**:
```sh
#!/bin/sh
```
Đây là chỉ thị dùng shell `sh` để thông dịch script.

**Kết thúc bằng**:
```sh
exit 0
```
Script chạy thành công, trả về mã `0`.

## Thực thi script

### Cách thực thi script

**Cách 1**: Gọi file trực tiếp:
```sh
/bin/sh first.sh
```

**Cách 2**: Biến file thành chương trình thực thi:
```sh
chmod +x first.sh
./first.sh
```
Trong đó:
- `chmod`: Là [[2. Các lệnh cơ bản quản lý file#Phân quyền|lệnh phân quyền]] file `first.sh` có quyền thực thi (`x`).
- `./first.sh`: Path của file, dùng để chạy file.

### Thực thi script với tham số

Script có thể nhận tham số đầu vào thông qua các [[3. Shell script#Biến tham số (Parameter variable)|biến tham số]]. Tham số được truyền vào được ngăn cách bởi dấu ` `, phía sau tên script.

VD:
```sh
/bin/sh first.sh "Cao Thai Bao" HTTT24
```
Truyền vào 2 tham số:
1. `"Cao Thai Bao"`.
2. `"HTTT24"`.

# Cú pháp Shell

Chú ý rằng Shell là ngôn ngữ nghiêm ngặt:
- Từng dấu cách (` `) đều được quy định.
- Mỗi lệch nằm trên 1 dòng.

## Biến (Variable)

### Biến do người dùng định nghĩa

Biến trong Shell không cần khai báo và mặc định là mang kiểu *string* và được Shell tự ép sang các kiểu khác khi cần. Nếu chuỗi có khoảng cách thì dùng cặp dấu `"`.

VD:
```sh
name="Cao Thai Bao"
echo $name
```
`Cao Thai Bao` được in ra màn hình.

### Biến môi trường (Environment variable)

Shell cung cấp sẵn một số biến được khai báo và gán trị mặc định. Chúng được gọi là các **biến môi trường**. Các biến môi trường thường được in hoa để phân biệt với các biến do người dùng định nghĩa.

| Biến môi trường | Ý nghĩa                                                                                                                       |
| --------------- | ----------------------------------------------------------------------------------------------------------------------------- |
| `$HOME`         | Nội dung của folder đầu tiên mà user đăng nhập.                                                                               |
| `$PATH`         | Chứa danh sách các đường dẫn (phân cách bằng `:`). Linux thường tìm các chương trình cần thi hành trong biến này để thực thi. |
| `$SP1`          | Dấu nhắc chính.                                                                                                               |
| `$SP2`          | Dấu nhắc thứ cấp.                                                                                                             |
| `$IFS`          | Danh sách các ký tự mà Shell dùng tách chuỗi                                                                                  |
| `$0`            | Tên script.                                                                                                                   |
| `$#`            | Số lượng biến tham số.                                                                                                        |
| `$$`            | Mã tiến trình (PID, Process ID) của script hiện tại đang chạy.                                                                |

### Biến tham số (Parameter variable)

Khi bạn chạy một shell script, bạn có thể truyền tham số (arguments) cho nó. Các tham số này sẽ được lưu vào biến đặc biệt gọi là **biến tham số**.

| Biến tham số    | Ý nghĩa                                                                |
| --------------- | ---------------------------------------------------------------------- |
| `$0`            | Tên script, và cũng là một Biến môi trường.                            |
| `$1`, `$2`, ... | Các biến tham số.                                                      |
| `$*`            | Danh sách các biến tham số, ngăn cách bởi ký tự đầu tiên trong `$IFS`. |
| `$@`            | Danh sách các biến tham số, không ngăn cách.                           |

## Ký tự đặc biệt (Metacharacter)

| Ký tự         | Ý nghĩa                                                                                   |
| ------------- | ----------------------------------------------------------------------------------------- |
| `> A`         | Đầu ra là `A` (ghi đè). `2>` là chuyển đầu ra lỗi.                                        |
| `>> A`        | Đầu ra là `A` (ghi thêm). `2>>` là chuyển đầu ra lỗi.                                     |
| `< A`         | Lấy dữ liệu từ `A`.                                                                       |
| `<< D A D`    | Lấy dữ liệu ngay tại script, giữa 2 chuỗi `D` liên tiếp do dev quy định.                  |
| `C &`         | Chạy nền lệnh `C`.                                                                        |
| `C1; C2; ...` | Chạy 3 lệnh `C1`, `C2`... trên cùng dòng.<br>Bạn có thể thay dấu `;` bằng dấu xuống dòng. |
| `` `C` ``     | Ưu tiên thực hiện lệnh `C` trước và đưa kết quả lệnh này vào dấu `` ` ``.                 |
| `C1 `\|` C2`  | Lấy kết quả của lệnh `C1` làm dữ liệu vào của lệnh `C2`.                                  |
| `"S"`         | Biểu diễn chuỗi `S`. Cho phép chèn giá trị biến bằng `$`.                                 |
| `'S'`         | Biểu diễn chuỗi `S`. Không cho phép chèn giá trị biến bằng `$`.                           |
| `\C`          | Bỏ ý nghĩa đặc biệt của ký tự `C`.                                                        |

## Biểu thức logic

Biểu thức logic `exp` thường được ký hiệu là `test exp` hoặc `[exp]`.

Có các loại biểu thức logic sau:

### Kiểm tra chuỗi

| Cú pháp        | True nếu     |
| -------------- | ------------ |
| `["A" = "B"]`  | A = B        |
| `["A" != "B"]` | A khác B     |
| `[-n "A"]`     | A không rỗng |
| `[-z "A"]`     | A rỗng       |

### Kiểm tra số

| Cú pháp     | True nếu |
| ----------- | -------- |
| `[A -eq B]` | A = B    |
| `[A -ne B]` | A khác B |
| `[A -gt B]` | A > B    |
| `[A -lt B]` | A < B    |
| `[A -ge B]` | A >= B   |
| `[A -le B]` | A <= B   |

### Kiểm tra file/folder

| Cú pháp  | True nếu                  |
| -------- | ------------------------- |
| `[-d F]` | `F` là folder.            |
| `[-f F]` | `F` là file.              |
| `[-e F]` | `F` có tồn tại.           |
| `[-r F]` | `F` cho phép đọc.         |
| `[-w F]` | `F` cho phép ghi.         |
| `[-x F]` | `F` cho phép thực thi.    |
| `[-s F]` | `F` có kích thước > 0.    |
| `[-g F]` | `F` được phân quyền SGID. |
| `[-u F]` | `F` được phân quyền SSID. |

Bạn có thể kiểm tra nội dung file bằng lệnh `grep`:
- `grep` sẽ tìm kiếm xem `pattern` có tồn tại trong nội dung `file` không, nếu có, trả về nội dung của match (nếu không có option `q`).
- Mệnh đề `grep` không cần đặt trong dấu `[]`.
```sh
grep [option] [pattern] [file]
```
Một số option của lệnh này là:
- `i`: Không phân biệt hoa, thường.
- `v`: Lấy các mẫu không khớp.
- `q`: Trả về true nếu có mẫu match.

### Biểu thức logic phức hợp

| Cú pháp      | True nếu                  |
| ------------ | ------------------------- |
| `[! L]`      | `L` false.                |
| `[L1 -a L2]` | Cả `L1` và `L2` đều true. |
| `[L1 -o L2]` | `L1` hoặc `L2` true.      |

## Cấu trúc điều kiển

### Nhập - xuất

```sh
echo val
```
Xuất `val`.

```sh
read name
```
Nhập giá trị vào biến `name`. Chú ý:
- `name` không cần khai báo trước.
- Nếu không nhập thì `name` không có giá trị chứ không phải `""`.

### Cấu trúc rẽ nhánh

#### If-else
```sh
if [...]; then
	# ...
else
	# ...
fi
```

#### If-Elif
```sh
if [...]; then
	# ...
elif [...];
	# ...
# ...
fi
```

### Cấu trúc lặp

#### For-in
```sh
for var in val1 val2 #...
do
	# ...
done
```
Trong đó: `var` là một biến lặp qua các giá trị `val1`, `val2`,...

#### While-do
```sh
while [...]; do
	# ...
done
```

#### Until-do
```sh
until [...]; do
	# ...
done
```
Điều kiện của util là **điều kiện dừng lặp** thay vì điều kiện lặp như for và while.

#### Case-in
```sh
case [...]; in
    pattern1) 
        # ...
        ;; 
    pattern2)
        # ...
        ;;
    ...
    *)
        # Default case
        # ...
        # ;;
esac
```
Trong đó:
- Pattern `*` được xem là match với tất cả giá trị.
	- `*` đứng một mình, được xem là default.
	- `*` đứng cạnh pattern khác, match với tất cả các giá trị ứng với vị trí của `*`. VD: `[Nn]*` -> match với bất kỳ chuỗi nào bắt đầu bằng `N` hoặc `n`.
- Pattern `A|B|C` match với `A`, `B` hoặc `C`.
- Pattern `[Nn]|[Oo]` match với `NO`, `nO`, `No`,... 

# Bài tập

**VD1**: Viết chương trình cho phép nhập vào tên và MSSV. Kiểm tra nếu MSSV đó không trùng với `24520145` thì bắt nhập lại. In ra màn hình kết quả.

```sh
#!/bin/sh

echo "Ho & ten:"
read hoten

echo "MSSV:"
read mssv

while [ "$mssv" != "24520145" ]; do
	echo "Trung MSSV. Hay nhap lai: "
	read mssv
done

echo "Ho & ten: $hoten"
echo "MSSV: $mssv"

exit 0
```

**VD2**: Viết chương trình cho phép nhập vào một số `n`. Kiểm tra nếu `n` < 10 thì bắt nhập lại. Tính tổng các số từ `1` đến `n`. In kết quả ra màn hình.

```sh
#!/bin/sh

echo "Nhap n: "
read n

while [ $n -lt 10 ]; do
	echo "Nhap lai n >= 10:"
	read n
done

tong=0
i=1
while [ $i -le $n ]; do
	tong=$(($tong+$i))
	i=$(($i+1))
done

echo "Tong tu 1 den $n: $tong"

exit 0
```

**VD2**: Viết trình cho phép nhập vào một chuỗi. Kiểm tra chuỗi đó có tồn tại trong một file `text.txt` cùng thư mục hay không.

```sh
#!/bin/sh

echo "Nhap chuoi s:"
read s

if grep -q "$s" text.txt; then
    echo "Chuoi '$s' co ton tai trong text.txt"
else
    echo "Chuoi '$s' khong ton tai trong text.txt"
fi

exit 0
```





