
```insta-toc
---
title:
  name: Mục lục
  level: 1
  center: false
exclude: ""
style:
  listType: number
omit: []
levels:
  min: 1
  max: 6
---

# Mục lục

1. Interface & Địa chỉ IP
2. Phân loại địa chỉ IP
    1. Phân loại dựa trên số lượng bit tổng thể
    2. Chuyển đổi IPv4 sang IPv6
    3. Phân loại dựa trên phạm vi sử dụng
    4. Các loại địa chỉ IP trong mạng
3. Cấu trúc địa chỉ IP
    1. Các thành phần của địa chỉ IP
    2. Subnet mask
4. Định dạng địa chỉ IPv4 & Phân lớp mạng
5. Chia mạng con bằng nhau
6. Một số dịch vụ của giao thức IP
    1. Chuyển dịch địa chỉ mạng (NAT, Network address translation)
    2. Cấu hình host động (DHCP, Dynamic host configuration protocol)
    3. Thông báo lỗi (ICMP, Internet message protocol)
```

>[!note]
>Khái niệm **địa chỉ IP** chỉ có trong mô hình **TCP/IP**.

# Interface & Địa chỉ IP

- **Cổng giao tiếp (Interface)**: kết nối giữa host/router và liên kết vật lý. Một host có thể có nhiều interface cho nhiều mạng khác nhau. VD: Interface cho *Wifi*, *Ethernet*, *Loopback (Localhost)* (mạng ảo cho phép máy tính tự kết nối với nó),...`
- **Địa chỉ IP (Internet protocol)**: Là mã định danh cho mỗi interface.

>[!note]
>Số lượng interface của router thường **nhiều hơn** các host.

# Phân loại địa chỉ IP

## Phân loại dựa trên số lượng bit tổng thể

|                   | **IPv4**                                                                                                                                                                                                                                                                                                                                                                                                                      | **IPv6**                                                                                                                                                                     |
| ----------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Một số trường** | (20 bytes)<br>- `ver`: Số phiên bản IP.<br>- `upper layer`: Giao thức tầng trên.<br>- `header length`.<br>- `length`.<br>- `type of service`.<br>- `identifier` (ID) (16 bits), `flag`, `offset`: Phục vụ cho phân mảnh, tổng hợp.<br>- `time to live` (TTL): Số hop tối đa còn lại ở mỗi router, mỗi hop là 1 lần đưa datagram sang 1 node mới.<br>- `checksum`.<br>- `source address`.<br>- `dest address`.<br>- options... | (32 bits)<br>- `ver`: Số phiên bản IP.<br>- `pri`: Mức độ ưu tiên xử lý luồng.<br>- `length`.<br>- `next hdr`.<br>- `hop limit`.<br>- `source address`.<br>- `dest address`. |
| **Số lượng bit**  | 32 = 4 octet = 4 byte                                                                                                                                                                                                                                                                                                                                                                                                         | 128                                                                                                                                                                          |
| **VD**            | `192.168.1.1`                                                                                                                                                                                                                                                                                                                                                                                                                 | `2001:0db8:85a3::8a2e:0370:7334`                                                                                                                                             |

Khi công nghệ ngày càng phát triển, càng nhiều host và mạng con, IPv4 thuần túy không thể chứa hết. Có 2 biện pháp.
- NAT: Network address translation.
- IPv6: Là mở rộng IPv4 với nhiều bit hơn.

**Ưu điểm của IPv6**:
- Không gian địa chỉ lớn, không cần NAT.
- Tự động cấu hình, không cần DHCP.
- Tốc độ xử lý cao: Do header có độ dài cố định 40 byte.
- Xử lý được nhiều luồng ở nhiều tầng mạng khác nhau.

## Chuyển đổi IPv4 sang IPv6

Sử dụng cơ chế **đường hầm (Packet in packet)**: Gói IPv6 sẽ được đưa vào payload của IPv4.

## Phân loại dựa trên phạm vi sử dụng

- **Private IP**: Sử dụng trong mạng *LAN*, ngoài mạng thì không truy cập được, có thể dùng nhiều lần cho các host. Các địa chỉ private thì sử dụng các địa chỉ IP dành riêng (*nói thêm ở phần phân lớp mạng*).
- **Public IP**: Sử dụng trong mạng *WAN*, dùng để định tuyến và có tính duy nhất cho mỗi host.
- **Loopback IP**: Sử dụng nội bộ trên 1 host, host đó có thể gửi và tự nhận dữ liệu.

## Các loại địa chỉ IP trong mạng

- **Địa chỉ cục bộ bên trong (Inside local address)**: Được phân phối cho các host bên trong mạng nội bộ.
- **Địa chỉ toàn cục bên trong (Inside global address)**: Đại diện cho một phần hay toàn bộ các địa chỉ cục bộ (NAT).
- **Địa chỉ cục bộ bên ngoài, Địa chỉ toàn cục bên ngoài** cũng có định nghĩa tương tự.

# Cấu trúc địa chỉ IP

## Các thành phần của địa chỉ IP

|                                     | Vị trí           | Cách nhận diện                            | Đặc điểm                                                                                                 |
| ----------------------------------- | ---------------- | ----------------------------------------- | -------------------------------------------------------------------------------------------------------- |
| **Địa chỉ mạng**<br>(Network)       | Đầu địa chỉ IP   | Các bit đầu khác `0`, các bit sau là `0`. | Là địa chỉ của mạng của các host, các host chung địa chỉ mạng có thể trao đổi mà không thông qua router. |
| **Địa chỉ host**                    | Giữa             | Giá trị nằm giữa `0` và `255`.            | Dùng để đặt tên cho các interface của các host. Các máy trong cùng mạng có địa chỉ host giống nhau.      |
| **Địa chỉ quảng bá**<br>(Broadcast) | Cuối địa chỉ IP. | Các bit cuối có giá trị `255`.            | Khi địa chỉ broadcast nhận được dữ liệu thì mọi host khác cùng mạng đều nhận được.                       |

## Subnet mask

**Subnet mask** 1 dãy 32 bit có `x` bit đầu tiên là `1`, các bit còn lại là `0`.
**Ký hiệu**: `bbbb.bbbb.bbbb.bbbb/x`.

Địa chỉ mạng được xác định bằng cách thực hiện phép **`AND` giữa địa chỉ IP và subnet mask**.

# Định dạng địa chỉ IPv4 & Phân lớp mạng

Địa chỉ IPv4 có 2 phần, được phân làm 5 lớp:
- **Phần mạng**: Chỉ ra số lượng mạng của lớp đó.
- **Phần host**: Chỉ ra số lượng host của lớp đó.

| Lớp   | Các bit đầu tiên | Giá trị của byte đầu tiên | **Private IP** | Số bit phần mạng | Mục đích        |
| ----- | ---------------- | ------------------------- | -------------- | ---------------- | --------------- |
| **A** | `0`              | `1-126...`                | `10...`        | 8                | Mạng lớn        |
| **B** | `10`             | `128-191...`              | `172.16-31..`  | 16               | Mạng trung bình |
| **C** | `110`            | `192-223...`              | `192.168..`    | 24               | Mạng nhỏ        |
| **D** | `1110`           | `224-239...`              | --             | --               | Multicast       |
| **E** | `1111`           | `240-254...`              | --             | --               | Nghiên cứu      |

>[!note]
>- Tổng số bit là **32**.
>- Địa chỉ có byte 1 là `127` dùng làm **Loopback**.

# Chia mạng con bằng nhau

**Chia mạng con**: Là phân chia 1 mạng lớn thành nhiều mạng nhỏ hơn (**Subnet**).
- Tiết kiệm, tận dụng địa chỉ IP.
- Phân hoạch thành các mạng riêng biệt, dễ quản lý.

Cho:
- Không gian địa chỉ `aaaa.bbbb.cccc.dddd/b_n`, $b_n$ là số bit phần mạng.
- Cần chia thành $n$ mạng con.
- Mỗi mạng con có $m$ host.
Để chia mạng con, ta cần **mượn thêm $b_b$ bit phần host** của địa chỉ trên để tạo thành subnet mask cho địa chỉ con.

**Các công thức tính số bit**:
- Số bit phần mạng (*subnet mask*): $\boxed{b_n}$.
- Số bit phần host: $\boxed{b_h=32-b_n}$.
- Số bit còn trống, có thể mượn để tạo thành MẠNG CON: $\boxed{1\leq b_b\leq b_h}$.
- Số MẠNG CON tối đa: $\boxed{n=2^{b_b}}$.
- Số host tối đa trong MẠNG CON: $\boxed{m=2^{b_h-b_b}-2}$ (*trừ 1 cho địa chỉ mạng và 1 cho địa chỉ broadcast*).
- Subnet của MẠNG CON: $\boxed{s_n=s+b_b}$.

>[!note]
>- Khi tạo mạng con thì mới cần mượn $b_b$ bits từ phần host của mạng cha.
>- Còn nếu chỉ tính các chỉ số của mạng cha thì $\boxed{b_b=0}$.

**Quy trình viết địa chỉ IP**: Do subnet mask có thể lẻ (không chia hết cho 8) nên không có công thức nào tính nhanh địa chỉ IP ở dạng thập phân mà phải chuyển qua nhị phân:
1. Tính địa chỉ *mạng*: Là **Subnet mask AND địa chỉ ban đầu**.
2. Tính địa chỉ *broadcast*: Là **Nghịch đảo Subnet mask OR địa chỉ ban đầu**.
3. Tính địa chỉ *host đầu*: Là địa chỉ mạng + 1.
4. Tính địa chỉ *host cuối*: Là địa chỉ broadcast - 1.


# Một số dịch vụ của giao thức IP

## Chuyển dịch địa chỉ mạng (NAT, Network address translation)

**NAT**: Là một kỹ thuật dùng để chuyển đổi **source IP và source port** của các host trong mạng nội bộ (*private IP*) sang phần còn lại của Internet. Toàn bộ các gói tin truyền từ mạng nội bộ sẽ mang một địa chỉ IP duy nhất.

**Cơ chế: Sử dụng bảng NAT translation table**:
- Chứa các cặp địa chỉ WAN và LAN tương ứng.
- Được cập nhật mỗi khi có request mới từ các host trong LAN.

**Phân loại**:
- **NAT tĩnh**: Một địa chỉ WAN / số port chỉ ứng với 1 địa chỉ LAN / số port.
- **NAT động**: Nhiều địa chỉ WAN / số port có thể ứng với nhiều địa chỉ LAN / số port.
- **PAT**: Một địa chỉ WAN / số port có thể ứng với nhiều địa chỉ LAN / số port.

**Lợi ích**:
- Các gói tin rời khỏi mạng nội bộ có cùng địa chỉ IP, giúp tiết kiệm địa chỉ IP.
- Chỉ cần thuê 1 địa chỉ IP từ ISP cho 1 mạng thay vì cho từng host.
- Có thể thay đổi địa chỉ IP của các host trong mạng nội bộ mà không cần thông báo cho bên ngoài biết.
- Các địa chỉ IP riêng tư sẽ được bảo vệ, các host bên ngoài chỉ có thể thấy địa chỉ NAT.

## Cấu hình host động (DHCP, Dynamic host configuration protocol)

Ban đầu, host có địa chỉ IP `0.0.0...`.
Khi một host tham gia mạng, nó:
- Tự động lấy địa chỉ IP từ **DHCP server**. Thường thì DHCP server được đặt chung router, phục vụ mặc định cho các host trong mạng đó.
- Gia hạn địa chỉ IP.
- Cho phép tái sử dụng địa chỉ IP.
- Hỗ trợ người dùng tham gia / rời mạng.

>[!note]
>Một địa chỉ IP có thể được tái gán cho nhiều host khác nhau.

**Quy trình - DORA**:
1. \[Tùy chọn] Host gửi **DHCP Discover** lên broadcast để tìm kiếm DHCP server.
2. \[Tùy chọn] (Các) DHCP server nhận được & phản hồi bằng **DHCP Offer**.
3. Host chọn 1 DHCP server *phản hồi nhanh nhất* để gửi **DHCP Request** lên broadcast yêu cầu nhận địa chỉ IP.
4. DHCP server gửi về **DHCP Ack** chứa *thời hạn sử dụng, địa chỉ IP, subnet mask, first-hop (default gateway), tên và địa chỉ IP của DNS server,...* và một số thông tin liên quan.

>[!note]
>- Nếu host chỉ **gia hạn địa chỉ IP** chứ không cần cấp mới thì không cần discover - offer.
>- Thường thì mỗi mạng chỉ có 1 DHCP server tại router.

**Bảo mật DHCP server**:
- DHCP có thể bị giả mạo và phản hồi các thông tin giả để trục lợi.
- Cách phòng chống: **DHCP snooping server**. Chỉ có kết nối giữa DHCP snooping server và DHCP server là trusted, còn lại là untrusted.

>[!note]
>Default gateway (first hop) thường là **địa chỉ router**.

## Thông báo lỗi (ICMP, Internet message protocol)

Khi một gói tin gửi đi có sự cố, ICMP gắn tại node sẽ trả về gói tin ICMP để báo lỗi cho host gửi gói tin ban đầu (*gửi về theo đúng thứ tự gửi đi*).

**Cấu trúc gói tin ICMP** (8 bytes):
- **Type** (1 byte): Mỗi loại mã ứng với 1 loại lỗi khác nhau.
- **Code** (1 byte).
- **Checksum** (2 bytes).
- **Trống** (4 bytes).

**Ứng dụng của ICMP**:
- **Kiểm tra tín hiệu đường truyền bằng lệnh `ping`**: Bên gửi sẽ gửi đến `dest` 4 gói ICMP và thống kê thời gian gửi / nhận, các gói mất / trễ....
- **Kiểm tra lộ trình truyền gói tin bằng lệnh `Tracert` (traceroute)**: Bên gửi gửi một loạt gói UDP đến đích với trường TTL tăng dần từ `1`. Khi gói thứ `i` đến router thứ `i`, router sẽ hủy gói tin đó và trả về gói ICMP chứa *tên và địa chỉ IP *của router về nguồn.

>[!important]
>Trong quá trình traceroute có thể xuất hiện một số gói trả về được gắn nhãn là `Request timed out` hay `*`. Nguyên nhân là:
>- Quả thật gói tin đó bị mất / bị trễ.
>- Router được cấu hình để không phản hồi gói tin.








