
```insta-toc
---
title:
  name: Mục lục
  level: 1
  center: false
exclude: ""
style:
  listType: number
omit: []
levels:
  min: 1
  max: 6
---

# Mục lục

1. Router
    1. Cấu trúc
    2. Cơ chế forward của cổng đầu vào
    3. Cơ chế quản lý hàng đợi
    4. Các chiến lược Định thời gửi gói của cổng đầu ra
    5. Tính trung lập của mạng
2. Phân mảnh và Tổng hợp IP
```

# Router

## Cấu trúc

Router gồm các thành phần:
1. **Input Ports (cổng đầu vào)**:
	- *Line termination*: Nhận tín hiệu vật lý.
	- *Link layer protocol*: Đóng gói frame.
	- *Lookup forwarding*: Tra cứu bảng forwarding để tìm cổng đầu ra. \[Giới thiệu sau].
	- *Queueing*: \[Giới thiệu sau].

3. **Switching Fabric**:
	- Là thành phần xương sống kết nối input ports và output ports.
	- Quyết định *tốc độ chuyển đổi (switching)*, được đo bằng bội số của tốc độ vào / ra của cổng vào / ra.
	- Có 3 loại fabric:
		1. **Memory** \[Cũ\]:
			- Gói tin được sao chép vào bộ nhớ hệ thống, được CPU chuyển tiếp trực tiếp.
			- Tốc độ phụ thuộc vào tốc độ băng thông bộ nhớ (tốn 2 bus).
		2. **Bus**:
			- Xây dựng 1 bus chung giữa đầu vào và ra, các gói tin có thể được truyền chung qua bus này.
			- Nhưng *tại 1 thời điểm chỉ có 1 gói được qua bus*, các gói khác phải chờ.
			- Tốc độ phụ thuộc vào tốc độ băng thông bus (*tranh chấp bus*).
		3. **Interconnection network** \[Hiện đại\]:
			- Các gói được truyền song song.
			- Tốc độ cao.
			- Gồm có các dạng:
				1. **Crossbar / Clos**: Xây dựng lưới circuit kết nối các cổng, gói tin sẽ đi dọc theo các circuit để đến đích.
				2. **Switch đa tầng**: Fabric được chia thành nhiều fabric nhỏ, các gói truyền qua các fabric nhỏ trung gian.

4. **Output Ports (cổng đầu ra)**:
	- *Datagram buffer*:
		- Là hàng đợi của output.
		- Đưa các gói tin vào bộ đệm. \[Giới thiệu sau].
		- Loại bỏ (Drop) gói tin nếu bộ đệm đầy.
		- Đánh dấu các gói có khả năng gây tắc nghẽn.
		- Định thời gửi gói tin.
	- *Link layer protocol*: Phân mảnh frame:
	- *Line terminator*: Gửi tín hiệu vật lý.

5. **Routing Processor (Bộ xử lý chuyển tiếp)**:
	- Nơi chạy control plane (các thuật toán định tuyến, quản lý).

## Cơ chế forward của cổng đầu vào

Forwarding dựa trên **bảng chuyển tiếp (Forward table)**.

Có 3 cách forward:
1. **Destination-based forwarding** \[Truyền thống]: Tra cứu theo địa chỉ IP đích.
2. **Longest Prefix Match**: Giống phương pháp trên nhưng không cần khớp IP đích 100% mà chỉ cần so khớp nhất có thể.
3. **Generalized forwarding**: Tra cứu theo bất kỳ trường header nào (SDN kiểu match-action).

## Cơ chế quản lý hàng đợi

Bộ nhớ đệm được dùng như là queue để đưa các gói vào.
1. **Input queuing**:
	- Nếu fabric không kịp, đưa gói vào queue ở input.
	- Có thể bị Head-of-the-Line (HOL) blocking: gói đầu tiên chặn các gói sau.

2. **Output queuing**:
	- Nếu tốc độ đầu ra nhỏ hơn tốc độ đến, đưa gói vào queue ở output.
	- Có thể mất gói (buffer overflow).

Kích thước bộ nhớ đệm:
- Theo quy tắc ngón tay cái RFC 3439:
$$\text{Buffer size}\leq\text{Bandwith}\times\text{RTT}$$
- Công thức cải tiến: Với $N$ là số luồng đồng thời qua liên kết thì:
$$\text{Buffer size}=\frac{\text{Bandwith}\times\text{RTT}}{\sqrt{\text{Number of flow}}} $$

>[!important]
>- Quá ít bộ nhớ đệm -> Mất gói.
>- Quá nhiều bộ nhớ đệm -> Tăng độ trễ.
>- RTT dài -> Gây trễ, Hiệu suất kém.

Các chiến lược quản lý bộ nhớ đệm:
1. **Drop-tail**: Bỏ gói đến khi bộ đệm đầy.
2. **Priority drop**: Loại gói theo mức ưu tiên.
3. **Marking**: Gắn cờ (RED, ECN) để báo hiệu tắc nghẽn thay vì drop ngay.

## Các chiến lược Định thời gửi gói của cổng đầu ra

Có 3 phương pháp định thời:
1. **FCFS/FIFO**: Gói đến trước thì được gửi đi trước.
2. **Priority queuing**: Gói có mức độ ưu tiên cao thì được gửi trước.
3. **Round Robin (RR)**: Phân bổ các gói vào hàng đợi riêng, định thời luân phiên giữa các hàng đợi.
4. **Weighted Fair Queuing (WFQ)**: Phân bổ băng thông theo trọng số (công bằng nhưng có thể ưu tiên).

## Tính trung lập của mạng

**Về mặt kỹ thuật**: Router không phân biệt traffic "theo ý riêng" (VD ưu tiên YouTube hơn Netflix).

**Về mặt xã hội**: Bảo vệ tự do ngôn luận, cạnh tranh công bằng.

Mỗi quốc gia có quan điểm khác nhau về trung lập mạng.

# Phân mảnh và Tổng hợp IP

Các đường link mạng đều có kích thước truyền tin tối đa (**Max transfer size - MTU**). Mỗi đường link có MTU khác nhau.
- **Phân mảnh**: Datagram bị router gửi chia ra thành nhiều gói nhỏ hơn rồi mới đưa lên link.
- **Tổng hợp**: Router nhận các gói nhỏ rồi ghép lại thành gói lớn.

Các trường / cờ dùng trong phân mảnh và tổng hợp:
- `length`: Tổng độ dài các gói con bằng gói cha.
- `identifier`: ID của các gói con và cha giống nhau.
- `fragflag`: Chỉ có *gói cha và gói con cuối cùng* mới được bật là `0`.
- `offset`: Thể hiện thứ tự gói con, $\boxed{\text{offset}_i=i\times\frac{\text{MTU}-20}{8}}$ (0-based, bytes).

Tổng số gói con được tạo ra:
$$\boxed{n=\lceil\frac{\text{length}-20}{\text{MTU}}\rceil}$$

>[!important]
>- *Tổng hợp* chỉ xảy ra khi đến **router đích**.
>- Độ dài gói tin bao gồm **payload và 20 bytes header**.

























