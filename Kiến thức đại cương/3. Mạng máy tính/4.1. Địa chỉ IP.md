
**Các bài viết trong mục 4 đều đang nói về NETWORK LAYER (INTERNET LAYER)**.

```insta-toc
---
title:
  name: Mục lục
  level: 1
  center: false
exclude: ""
style:
  listType: number
omit: []
levels:
  min: 1
  max: 6
---

# Mục lục

1. Interface & Địa chỉ IP
2. Phân loại địa chỉ IP
    1. Phân loại dựa trên số lượng bit tổng thể
    2. Chuyển đổi IPv4 sang IPv6
    3. Phân loại dựa trên phạm vi sử dụng
    4. Các loại địa chỉ IP trong mạng
3. Cấu trúc địa chỉ IP
    1. Các thành phần của địa chỉ IP
    2. Subnet mask, Địa chỉ mạng, Địa chỉ broadcast
4. Phân lớp mạng
5. Chia mạng con bằng nhau
6. Một số dịch vụ của giao thức IP
    1. Chuyển dịch địa chỉ mạng (NAT, Network address translation)
    2. Cấu hình host động (DHCP, Dynamic host configuration protocol)
    3. Thông báo lỗi (ICMP, Internet message protocol)
```

>[!note]
>Khái niệm **địa chỉ IP** chỉ có trong mô hình **TCP/IP**.

# Interface & Địa chỉ IP

- **Cổng giao tiếp (Interface)**: kết nối giữa host/router và liên kết vật lý. Một host có thể có nhiều interface cho nhiều mạng khác nhau. VD: Interface cho *Wifi*, *Ethernet*, *Loopback (Localhost)* (mạng ảo cho phép máy tính tự kết nối với nó),...`
- **Địa chỉ IP (Internet protocol)**: Là mã định danh cho mỗi interface.

>[!note]
>Số lượng interface của router thường **nhiều hơn** các host.

# Phân loại địa chỉ IP

## Phân loại dựa trên số lượng bit tổng thể

|                   | **IPv4**                                                                                                                                                                                                                                                                                                                                                                                                                      | **IPv6**                                                                                                                                                                     | MAC                                        |
| ----------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------ |
| **Một số trường** | (20 bytes)<br>- `ver`: Số phiên bản IP.<br>- `upper layer`: Giao thức tầng trên.<br>- `header length`.<br>- `length`.<br>- `type of service`.<br>- `identifier` (ID) (16 bits), `flag`, `offset`: Phục vụ cho phân mảnh, tổng hợp.<br>- `time to live` (TTL): Số hop tối đa còn lại ở mỗi router, mỗi hop là 1 lần đưa datagram sang 1 node mới.<br>- `checksum`.<br>- `source address`.<br>- `dest address`.<br>- options... | (32 bits)<br>- `ver`: Số phiên bản IP.<br>- `pri`: Mức độ ưu tiên xử lý luồng.<br>- `length`.<br>- `next hdr`.<br>- `hop limit`.<br>- `source address`.<br>- `dest address`. | --                                         |
| **Độ dài**        | **32 bits** = 4 octets = 4 bytes                                                                                                                                                                                                                                                                                                                                                                                              | **128 bits** = 16 bytes                                                                                                                                                      | **48 bits** = 6 bytes                      |
| **VD**            | `192.168.1.1`                                                                                                                                                                                                                                                                                                                                                                                                                 | `2001:0db8:85a3::8a2e:0370:7334`                                                                                                                                             | `FF-FF-FF-FF-FF-FF` hoặc `FFFF.FFFF.FFFF`. |

Khi công nghệ ngày càng phát triển, càng nhiều host và mạng con, IPv4 thuần túy không thể chứa hết. Có 2 biện pháp.
- NAT: Network address translation.
- IPv6: Là mở rộng IPv4 với nhiều bit hơn.

**Ưu điểm của IPv6**:
- Không gian địa chỉ lớn, không cần NAT.
- Tự động cấu hình, không cần DHCP.
- Tốc độ xử lý cao: Do header có độ dài cố định 40 byte.
- Xử lý được nhiều luồng ở nhiều tầng mạng khác nhau.

## Chuyển đổi IPv4 sang IPv6

Sử dụng cơ chế **đường hầm (Packet in packet)**: Gói IPv6 sẽ được đưa vào payload của IPv4.

## Phân loại dựa trên phạm vi sử dụng

- **Private IP**:
	- Sử dụng trong mạng *LAN*, ngoài mạng thì không truy cập được, có thể dùng nhiều lần cho các host.
	- Các private IP: `10`, `127.16-31`, `192.168`.
	
- **Public IP**:
	- Sử dụng trong mạng *WAN*, dùng để định tuyến và có tính duy nhất cho mỗi host.
	
- **Loopback IP (`127`)**:
	- Sử dụng nội bộ trên 1 host, host đó có thể gửi và tự nhận dữ liệu.

>[!note]
>Chỉ có **public IP** mới có thể dùng để gán cho mỗi host và kết nối mạng Internet.

## Các loại địa chỉ IP trong mạng

- **Địa chỉ cục bộ bên trong (Inside local address)**: Được phân phối cho các host bên trong mạng nội bộ.
- **Địa chỉ toàn cục bên trong (Inside global address)**: Đại diện cho một phần hay toàn bộ các địa chỉ cục bộ (NAT).
- **Địa chỉ cục bộ bên ngoài, Địa chỉ toàn cục bên ngoài** cũng có định nghĩa tương tự.

# Cấu trúc địa chỉ IP

## Các thành phần của địa chỉ IP

|                                     | Vị trí           | Cách nhận diện                            | Đặc điểm                                                                                                 |
| ----------------------------------- | ---------------- | ----------------------------------------- | -------------------------------------------------------------------------------------------------------- |
| **Địa chỉ mạng**<br>(Network)       | Đầu địa chỉ IP   | Các bit đầu khác `0`, các bit sau là `0`. | Là địa chỉ của mạng của các host, các host chung địa chỉ mạng có thể trao đổi mà không thông qua router. |
| **Địa chỉ host**                    | Giữa             | Giá trị nằm giữa `0` và `255`.            | Dùng để đặt tên cho các interface của các host. Các máy trong cùng mạng có địa chỉ host giống nhau.      |
| **Địa chỉ quảng bá**<br>(Broadcast) | Cuối địa chỉ IP. | Các bit cuối có giá trị `255`.            | Khi địa chỉ broadcast nhận được dữ liệu thì mọi host khác cùng mạng đều nhận được.                       |

## Subnet mask, Địa chỉ mạng, Địa chỉ broadcast

**Subnet mask** 1 dãy 32 bit có **`x` bit đầu tiên là `1`**, các bit còn lại là `0`.
- **Ký hiệu**: `bbbb.bbbb.bbbb.bbbb/x`.

Địa chỉ IPv4 có 2 phần:
- **Phần mạng**: Chỉ ra số lượng mạng của lớp đó.
- **Phần host**: Chỉ ra số lượng host của lớp đó.

**Cách xác định địa chỉ mạng và địa chỉ broadcast dựa vào địa chỉ 1 host bất kỳ trong mạng**:
- **Địa chỉ mạng**: Thực hiện `AND` giữa địa chỉ host và subnet mask (tức là lấy `x` bit đầu tiên, còn lại bật `0`).
- **Địa chỉ broadcast**: Bật các bit phần host của địa chỉ mạng **lên `1`**.

>[!note] Cách xác định subnet mask từ 1 dãy bit subnet mask
>-> Subnet mask là **số lượng bit `1` trái cùng**.

# Phân lớp mạng

Dựa vào số lượng bit phần mạng, có 5 lớp địa chỉ:

| Lớp   | Những bit đầu tiên | Dãy byte đầu tiên             | Subnet mask | Mục đích        |
| ----- | ------------------ | ----------------------------- | ----------- | --------------- |
| **A** | `0`                | `00000001`<br>-<br>`01111110` | `/8`        | Mạng lớn        |
| **B** | `10`               | `10000000`<br>-<br>`10111111` | `/16`       | Mạng trung bình |
| **C** | `110`              | `11000000`<br>-<br>`11011111` | `/24`       | Mạng nhỏ        |
| **D** | `1110`             | `11100000`<br>-<br>`11101111` | --          | Multicast       |
| **E** | `1110`             | `11110000`<br>-<br>`11111110` | --          | Nghiên cứu      |

>[!note]
>- Lớp thứ `i` (0-based) có `i` bit `1` đầu tiên.
>- Tổng số bit là **32**.
>- Trong dãy bit đầu lớp **A** bị khuyết thiếu 2 địa chỉ là:
>	- `00000000` (`0`): **This network**.
>	- `01111111` (`127`): **Loopback network**.
>- Trong dãy bit đầu lớp **E** bị khuyết thiếu 1 địa chỉ là:
>	- `11111110` (`254`): **Limited broadcast**.

# Chia mạng con bằng nhau

**Chia mạng con**: Là phân chia 1 mạng lớn thành nhiều mạng nhỏ hơn (**Subnet**).
- Tiết kiệm, tận dụng địa chỉ IP.
- Phân hoạch thành các mạng riêng biệt, dễ quản lý.

**Công thức**:

|                                     | Mạng cha | Mạng con    |
| ----------------------------------- | -------- | ----------- |
| **Số bit phần mạng (subnet mask)**  | $n$      | $n+b$       |
| **Số bit phần host**                | $h$      | $h-b$       |
| **Số mạng con tối đa**              | $2^b$    | $2^b$       |
| **Số mạng con sử dụng được tối đa** | $2^b-2$  | $2^b-2$     |
| **Số host (sử dụng được) tối đa**   | $2^h-2$  | $2^{h-b}-2$ |

Trong đó:
- $b$ là số bit **mượn từ phần host của mạng cha** để tạo thành mạng con.
- $\max(b)=h-1$.
- $32=h+n$.

>[!note]
>Trên thực tế, mượn càng nhiều bit thì sẽ tạo ra càng nhiều host, **nhưng ta phải mượn ít bit nhất có thể**.

# Một số dịch vụ của giao thức IP

## Chuyển dịch địa chỉ mạng (NAT, Network address translation)

**NAT**: Là một kỹ thuật dùng để chuyển đổi **source IP và source port** của các host trong mạng nội bộ (*private IP*) sang phần còn lại của Internet. Toàn bộ các gói tin truyền từ mạng nội bộ sẽ mang một địa chỉ IP duy nhất.

**Cơ chế: Sử dụng bảng NAT translation table**:
- Chứa các cặp địa chỉ WAN và LAN tương ứng.
- Được cập nhật mỗi khi có request mới từ các host trong LAN.

**Phân loại**:
- **NAT tĩnh**: Một địa chỉ WAN / số port chỉ ứng với 1 địa chỉ LAN / số port.
- **NAT động**: Nhiều địa chỉ WAN / số port có thể ứng với nhiều địa chỉ LAN / số port.
- **PAT**: Một địa chỉ WAN / số port có thể ứng với nhiều địa chỉ LAN / số port.

**Lợi ích**:
- Các gói tin rời khỏi mạng nội bộ có cùng địa chỉ IP, giúp tiết kiệm địa chỉ IP.
- Chỉ cần thuê 1 địa chỉ IP từ ISP cho 1 mạng thay vì cho từng host.
- Có thể thay đổi địa chỉ IP của các host trong mạng nội bộ mà không cần thông báo cho bên ngoài biết.
- Các địa chỉ IP riêng tư sẽ được bảo vệ, các host bên ngoài chỉ có thể thấy địa chỉ NAT.

## Cấu hình host động (DHCP, Dynamic host configuration protocol)

Ban đầu, host có địa chỉ IP `0.0.0...`.
Khi một host tham gia mạng, nó:
- Tự động lấy địa chỉ IP từ **DHCP server**. Thường thì DHCP server được đặt chung router, phục vụ mặc định cho các host trong mạng đó.
- Gia hạn địa chỉ IP.
- Cho phép tái sử dụng địa chỉ IP.
- Hỗ trợ người dùng tham gia / rời mạng.

>[!note]
>Một địa chỉ IP có thể được tái gán cho nhiều host khác nhau.

**Quy trình - DORA**:
1. \[Tùy chọn] Host gửi **DHCP Discover** lên broadcast để tìm kiếm DHCP server.
2. \[Tùy chọn] (Các) DHCP server nhận được & phản hồi bằng **DHCP Offer**.
3. Host chọn 1 DHCP server *phản hồi nhanh nhất* để gửi **DHCP Request** lên broadcast yêu cầu nhận địa chỉ IP.
4. DHCP server gửi về **DHCP ACK** chứa *thời hạn sử dụng, địa chỉ IP, subnet mask, first-hop (default gateway), tên và địa chỉ IP của DNS server,...* và một số thông tin liên quan.

>[!note]
>- Nếu host chỉ **gia hạn địa chỉ IP** chứ không cần cấp mới thì không cần discover - offer.
>- Thường thì mỗi mạng chỉ có 1 DHCP server tại router.

**Bảo mật DHCP server**:
- DHCP có thể bị giả mạo và phản hồi các thông tin giả để trục lợi.
- Cách phòng chống: **DHCP snooping server**. Chỉ có kết nối giữa DHCP snooping server và DHCP server là trusted, còn lại là untrusted.

>[!note]
>Default gateway (first hop) thường là **địa chỉ router**.

>[!note]
>DHCP là giao thức ở tầng Application, hoạt động dựa trên UDP, port = 67/68.

## Thông báo lỗi (ICMP, Internet message protocol)

Khi một gói tin gửi đi có sự cố, ICMP gắn tại node sẽ trả về gói tin ICMP để báo lỗi cho host gửi gói tin ban đầu (*gửi về theo đúng thứ tự gửi đi*).

**Cấu trúc gói tin ICMP** (8 bytes):
- **Type** (1 byte): Mỗi loại mã ứng với 1 loại lỗi khác nhau.
- **Code** (1 byte).
- **Checksum** (2 bytes).
- **Trống** (4 bytes).

**Ứng dụng của ICMP**:
- **Kiểm tra tín hiệu đường truyền bằng lệnh `ping`**: Bên gửi sẽ gửi đến `dest` 4 gói ICMP và thống kê thời gian gửi / nhận, các gói mất / trễ....
- **Kiểm tra lộ trình truyền gói tin bằng lệnh `tracert` (`traceroute`)**: Bên gửi gửi một loạt gói UDP đến đích với trường TTL tăng dần từ `1`. Khi gói thứ `i` đến router thứ `i`, router sẽ hủy gói tin đó và trả về gói ICMP chứa *tên và địa chỉ IP *của router về nguồn.

Một số chỉ báo của `traceroute` (`route print`):
- `Network destination`: Địa chỉ mạng đích. Địa chỉ đầu tiên là `0.0.0.0` (default route).
- `Netmask`: Netmask mạng đích.
- `Gateway`: Địa chỉ IP của router tiếp theo.
- `Interface`: Địa chỉ IP của host hiện tại.
- `Metric`: Chi phí đường đi đã dùng.

>[!important]
>Trong quá trình traceroute có thể xuất hiện một số gói trả về được gắn nhãn là `Request timed out` hay `*`. Nguyên nhân là:
>- Quả thật gói tin đó bị mất / bị trễ.
>- Router được cấu hình để không phản hồi gói tin.








