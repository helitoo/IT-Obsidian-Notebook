
# Cài đặt

Có 2 hạ tầng cài đặt MongoDB:
- **Local server**:
	- [MongoDB Community edition](https://www.mongodb.com/try/download/community) (*`.msi` package*).
	- Datatabase được quản lý qua **MongoDB shell (mongosh)**. Xem [MongoDB tools](https://www.mongodb.com/try/download/terraform-provider) (*`.msi` package*).
	- **MongoDB compass**: GUI quản lý databases. Đơn vị lưu trữ là **Connection**, mỗi connection có nhiều database.
- **Cloud server**:
	- [MongoDB Atlas](https://cloud.mongodb.com/v2/6965e933896fc5a274e9a909#/overview). Đơn vị dự án của Atlas là **Cluster**, chứa các databases, collections,...

Kết nối với MongoDB Shell:
```sh
mongosh
```

# Một số thao tác trên MongoDB

Các lệnh sau được thực thi trong MongoDB Shell:

## Các lệnh chung chung

| Lệnh                                                          | Ý nghĩa                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| ------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `cls`                                                         | Xóa màn hình.                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| `mongosh`                                                     | **Kết nối** với MongoDB Shell.                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `Ctrl` `C`<br>`exit`                                          | **Ngắt kết nối** với MongoDB Shell.                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| `show dbs`                                                    | **Xem** danh sách databases.                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| `show collections`                                            | **Xem** danh sách collections.                                                                                                                                                                                                                                                                                                                                                                                                                                               |

## Các lệnh Thêm, Xóa, Sửa

| Lệnh                                      | Ý nghĩa                                                                                                                                 |
| ----------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------- |
| `db.clt.insertOne({key: value,...})`      | **Thêm** document `{key: value,...}` vào collection `clt` của database `db`.<br><br>Nếu `clt` chưa tồn tại thì MongoDB sẽ *tự tạo mới*. |
| `db.clt.insertMany([{key: value,...}])`   | Tương tự với `.insertOne` nhưng cho phép insert cùng lúc nhiều documents.                                                               |
| `db.clt.deleteOne()`                      | **Xóa** document.<br><br>Cú pháp giống `.findOne()`.                                                                                    |
| `db.clt.deleteMany()`                     | **Xóa** document.<br><br>Cú pháp giống `.find()`.                                                                                       |
| `db.clt.updateOne({...}, {$set: {...}})`  | **Cập nhật** document thành giá trị giống với `$set`.<br><br>Xem thêm tại *Các cú pháp cập nhật*.<br><br>Cú pháp giống `.findOne()`.    |
| `db.clt.updateMany({...}, {$set: {...}})` | **Cập nhật** document thành giá trị giống với `$set`.<br><br>Xem thêm tại *Các cú pháp cập nhật*.<br><br>Cú pháp giống `.find()`.       |

| Cú pháp                      | Ý nghĩa                                                |
| ---------------------------- | ------------------------------------------------------ |
| `{$inc: {k: n}}`             | Tăng `k` thêm `n` đơn vị. `n` có thể âm.               |
| `{$pull: {k: v}}`            | Lấy giá trị `v` ra khỏi `k` (`k` là mảng).             |
| `{$push: {k: v}}`            | Thêm `v` vào `k` (`k` là mảng).                        |
| `{$each: {k: [v1, v2,...]}}` | Thêm các giá trị `v1`, `v2`,... vào `k` (`k` là mảng). |

## Các lệnh đọc

| Lệnh                                                          | Ý nghĩa                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| ------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `db.clt.find()`<br><br>`db.clt.find({key: value,...}, {...})` | **Truy vấn** 20 document đầu tiên.<br><br>`.find()` *có thể* có 2 tham số:<br><br>1. **Điều kiện lọc**: Tìm các document chứa cặp `{key: value, ...}` tương ứng trong đối số. Nếu đối số là `{}` thì coi như *tìm kiếm toàn bộ*. Xem thêm tại *Các cú pháp lọc*.<br><br>2. **Thuộc tính hiển thị**: Là 1 document mà value là `1` hoặc `0`. Nếu như key có value là `1` thì sẽ hiển thị key đó, không thì ẩn đi.<br><br>Lệnh `it` sẽ hiển thị cứ mỗi 20 documents tiếp theo. |
| `db.clt.findOne()`                                            | Tương tự `.find()` nhưng chỉ hiển thị 1 kết quả đầu tiên.                                                                                                                                                                                                                                                                                                                                                                                                                    |

`.find()` và `.findOne()` có một số phương thức như sau:

| Phương thức    | Ý nghĩa                                                                                                                                               |
| -------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------- |
| `.count()`     | Số lượng document trả về.                                                                                                                             |
| `.limit(n)`    | Chỉ hiển thị `n` document đầu tiên.                                                                                                                   |
| `.sort({...})` | Sắp xếp.<br><br>`.sort()` nhận 1 tham số là document là value là `1` hoặc `-1`. Nếu là `1`, sắp xếp key đó theo thứ tự *tăng dần*, ngược lại là `-1`. |

**Các cú pháp lọc:**

| Cú pháp                           | Ý nghĩa                                        |
| --------------------------------- | ---------------------------------------------- |
| `{k: {$gt: n}}`                   | $k>n$<br>(Tương tự với `$lt`)                  |
| `{k: {$gte: n}}`                  | $k\geq n$<br>(Tương tự với `$lte`)             |
| `{k1: v1, k2: v2,...}`            | $k_1=v_1\wedge k_2=v_2\wedge...$               |
| `{$or: [{k1: v1}, {k2: v2},...]}` | $k_1=v_1\vee k_2=v_2\vee...$                   |
| `{k: {$in: [v1, v2,...]}}`        | $k\in\{v_1,v_2,...\}$<br>(Tương tự với `$nin`) |
| `{k: {$all: [v1, v2,...]}}`       | $\{v_1,v_2,...\}\subset k$                     |

## Chiến lược thực thi truy vấn của MongoDB

Xem thống kê về collection `clt`:
```sh
db.runCommand({collStats: 'clt'})
```

Để xem chiến lược thực thi của lệnh `.find()`, dùng thuộc tính sau:
```sh
.explain('executionStats')
```

Phương thức trên có 1 số thông số quan trọng như sau:
- `totalDocsExamined`: Số lượng document cần phải quét.
- `nReturned`: Số lượng document trả về.
- `queryPlan.stage`: Thuật toán truy vấn.

Có 1 số giải thuật như sau:
- `COLLSCAN` (Collection scan): Quét toàn bộ document.
- `IXSCAN` (Index scan): 

Tạo index:
```sh
db.clt.createIndex({...}, {name: 'IDX_NAME'})
```

Xóa index:
```sh
db.clt.dropIndex('IDX_NAME')
```

Kiểm tra index:
```sh
db.clt.getIndexes()
```





# Drivers

Để sử dụng MongoDB qua các ngôn ngữ lập trình, cần dùng **Drivers**. Xem thêm tại [MongoDB/Drivers](https://www.mongodb.com/docs/drivers/).




























