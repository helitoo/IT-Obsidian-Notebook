
# Một số helper

## Thời điểm

```python
datetime.datetime(year, month, day)
```
Ngoài ra có thể truyền thêm các tham số `hour`, `minute`, `second`, `tz` (*timezone*).

## Khoảng thời gian

```python
datetime.timedelta(days, hours, minutes)
```

## Cron expression

Là cú pháp đặc biệt của Airflow dùng để biểu diễn lịch thực thi (chạy) của DAG.

Gồm có 5 trường, đọc từ trái sang phải.
1. Trường 1: Hàng phút (`0` - `59`).
2. Trường 2: Hàng giờ (`0` - `23`).
3. Trường 3: Hàng ngày trong tháng (`1` - `31`).
4. Trường 4: Hàng tháng (`1` - `12`).
5. Trường 5: Hàng ngày trong tuần (`0` - `7`).

Công cụ hỗ trợ viết cron: [Crontab guru](https://crontab.guru/).

VD:

| Preset        | Cron           | Ý nghĩa                                                            |
| ------------- | -------------- | ------------------------------------------------------------------ |
| `None`        | --             | Không chạy.                                                        |
| `@once`       | --             | Chạy 1 lần.                                                        |
| `@continuous` | --             | Chạy liên tiếp.                                                    |
| `@hourly`     | `0 * * * *`    | Chạy 1 lần vào lúc `0`' mỗi giờ.                                   |
| `@daily`      | `0 0 * * *`    | Chạy 1 lần vào lúc `0`:`0` mỗi ngày.                               |
| `@weekly`     | `0 0 * * 0`    | Chạy 1 lần vào lúc `0`:`0` mỗi Chủ Nhật.                           |
| `@monthly`    | `0 0 1 * *`    | Chạy 1 lần vào lúc `0`:`0` của ngày đầu tiên mỗi tháng.            |
| `@quarterly`  | `0 0 1 */3 *`  | Chạy 1 lần lúc `0`:`0` của ngày `1` mỗi tháng, cứ `3` tháng 1 lần. |
| `@yearly`     | `0 0 1 1 *`    | Chạy 1 lần vào lúc `0`:`0` ngày 1 tháng 1.                         |
| --            | `0 9,18 * * *` | Chạy 2 lần vào `9`h và `18`h mỗi ngày.                             |
| --            | `0 9-18 * * *` | Chạy mỗi giờ từ `9`h đến `18`h mỗi ngày.                           |
| --            | `*/5 * * * *`  | Chạy 1 lần cứ sau mỗi `5` phút.                                    |

# Task

Tài liệu tham khảo:
- [Apache Airflow / Operators](https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/operators.html)
- [Apache Airflow / Xcoms](https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/xcoms.html).

## Khai báo task

Mỗi task thực chất là instance của 1 operator, có rất nhiều operator trong Airflow:

**Một số tham số chung của operator**:

| Tham số                  | Ý nghĩa                                                                                         |
| ------------------------ | ----------------------------------------------------------------------------------------------- |
| `task_id`                | ID của task.                                                                                    |
| `owner`                  | Tên tác giả của task.                                                                           |
| `retries`                | Số lần chạy lại task khi task thất bại.                                                         |
| `retry_delay`            | Khoảng thời gian chờ giữa các retry.                                                            |
| `execution_timeout`      | Thời gian chạy tối đa.                                                                          |
| `task_concurrency`       | Số task được chạy song song.                                                                    |
| `multiple_outputs=False` | Nếu là `True`, Airflow sẽ tách các key của returned value thành các biến riêng và đưa vào Xcom. |

**Cách 1 - Dùng class constructor**:
```python
my_task = PythonOperator(task_id="my_task", python_callable=task_handler)
```

**Cách 1 - Dùng decorator**: Coi mỗi task như 1 function được gắn decorator `@dag`:
```python
@task()
def task_handler():
	# ...

my_task = task_handler()
```

## Một số operator

**`BashOperator`**: Thực thi `bash_command` tại bash.
```python
airflow.providers.standard.operators.bash.BashOperator(task_id, bash_command)
```

**`PythonOperator`**: Thực thi hàm `python_callable`.
```python
airflow.providers.standard.operators.python.PythonOperator(task_id, python_callable)
```
- `python_callable` là tên của hàm Python.
- `op_kwargs`: Danh sách đối số của `python_callable`, có dạng 1 dict `{paramName: value, ...}`.

**`PostgresOperator`**: Thực thi lệnh `sql` vào Postgres database.
```python
airflow.providers.postgres.operators.postgres.PostgresOperator(task_id, postgres_conn_id, sql)
```
- `postgres_conn_id`: Mã Connection đến Postgres, khởi tạo bằng GUI: Admin -> Connection.

## Sensor

Sensor là các operator đặc biệt, chỉ được thực thi khi một sự kiện nào đó xảy ra.

Tài liệu tham khảo:
- [Apache Airflow / Standard sensors](https://airflow.apache.org/docs/apache-airflow-providers-standard/stable/sensors/index.html).
- [Apache Airflow / Providers packages](https://airflow.apache.org/docs/#:~:text=Read%20the%20documentation%20%C2%BB-,Active%20providers,-Airbyte) (*và tìm API `sensor` tương ứng với nhà cung cấp*).

# DAG

Tài liệu tham khảo:
- [Apache Airflow / DAGs](https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/dags.html).
- [Apache Airflow / Authoring and Scheduling](https://airflow.apache.org/docs/apache-airflow/stable/authoring-and-scheduling/index.html).

## Khai báo DAG

Mỗi DAG được định nghĩa trong 1 file `.py` trong `dags/`.

Có rất nhiều cách để tạo DAG, nhưng vẫn có công thức chung là tạo instance của `airflow.DAG`.

**Một số tham số của `airflow.DAG`**:

| Tham số               | Ý nghĩa                                                                                                                                                                                                                   |
| --------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `dag_id`              | ID của DAG.<br>Lưu ý rằng DAG *không thể thay đổi ID bằng source code*. Mỗi lần ID của DAG thay đổi, Airflow sẽ hiểu đó là 1 version mới của DAG.                                                                         |
| `schedule`            | Lịch chạy DAG. Có giá trị là preset hoặc cron expression.                                                                                                                                                                 |
| `start_date`          | Thời điểm bắt đầu lập lịch.                                                                                                                                                                                               |
| `catchup=False`       | Nếu là `False`, DAG sẽ được chạy từ ngày hiện tại trở đi.<br>Chú ý rằng ngày hiện tại có thể trễ hơn so với `start_date`. Nếu điều này xảy ra và `catchup=True`, Airflow sẽ thực hiện task bù vào quá khứ (**backfill**). |
| `max_active_runs`     | Số DAG chạy song song tối đa.                                                                                                                                                                                             |
| `tags`                | Một `string[]` chứa danh sách các tag do dev định nghĩa, nhằm dễ phân loại.                                                                                                                                               |
| `description`         | Mô tả DAG.                                                                                                                                                                                                                |
| `timezone`            | Timezone của DAG.                                                                                                                                                                                                         |
| `on_success_callback` | Hàm được gọi khi DAG thành công.                                                                                                                                                                                          |
| `on_failure_callback` | Hàm được gọi khi DAG thất bại.                                                                                                                                                                                            |
| `default_args`        | Tham số mặc định cho các task của DAG. Là một `dict`.                                                                                                                                                                     |

**Cách 1 - Context manager**: Dùng `with`:
```python
 import datetime
 from airflow.sdk import DAG

 with DAG(
     dag_id="my_dag_name",
     start_date=datetime.datetime(2021, 1, 1),
     schedule="@daily",
 ):
     # Task defination
     
     # Task dependencies
```

**Cách 2 - Decorator**: Coi mỗi DAG như 1 function được gắn decorator `@dag`:
```python
import datetime
from airflow.sdk import dag

@dag(start_date=datetime.datetime(2021, 1, 1), schedule="@daily")
def generate_dag():
    # Task defination
    # Task dependencies


generate_dag()
```

## Task dependencies

Cú pháp:

| Shortcut | Phương thức đầy đủ    | Ý nghĩa                                  |
| -------- | --------------------- | ---------------------------------------- |
| `A >> B` | `A.set_downstream(B)` | Task `A` được thực thi trước task `B`.   |
| `A << B` | `A.set_upstream(B)`   | Task `A` được thực thi sau task `B`.     |
| `[A, B]` | --                    | Task `A` và `B` được thực thi song song. |

## Task flow API

Đối với cú pháp khai báo bằng *decorator* và dùng *PythonOperator*, Airflow hỗ trợ **tự động định nghĩa task dependencies**.

VD:
```python
from datetime import datetime, timedelta
from airflow.decorators import dag, task

@dag(dag_id='dag_with_taskflow_api', 
     start_date=datetime(2021, 10, 26), 
     schedule_interval='@daily')
def hello_world_etl():
	
    @task(multiple_outputs=True)
    def get_name():
        return {
            'first_name': 'Jerry',
            'last_name': 'Fridman'
        }
	
    @task()
    def get_age():
        return 19
	
    @task()
    def greet(first_name, last_name, age):
        print(f"My name is {first_name} {last_name}. I am {age} years old!")
    
    # -> Airflow can define its own dependencies
    # based on the returned values by tasks
    name_dict = get_name()
    age = get_age()
    greet(first_name=name_dict['first_name'], 
          last_name=name_dict['last_name'],
          age=age)

greet_dag = hello_world_etl()
```

# Cross-communication (Xcom)

**Xcom** (Cross-communication) là một môi trường lưu dữ liệu chung giữa các task, nơi một task có thể gửi dữ liệu lên và một task khác lấy dữ liệu về.
Chú ý rằng Xcom chỉ có **48 KB**, cho nên chỉ thích hợp để truyền *metadata* mà thôi.

|                                     | Bên push (`A`)                                                   | Bên pull (`B`)                        |
| ----------------------------------- | ---------------------------------------------------------------- | ------------------------------------- |
| **Trường hợp push-pull 1 biến**     | Airflow sẽ tự động lấy *giá trị trả về* của `A` để đưa vào Xcom. | `ti.xcom_pull(task_ids='A')`          |
| **Trường hợp push-pull nhiều biến** | `ti.xcom_push(key='k', value='v')`                               | `ti.xcom_pull(task_ids='A', key='k')` |

**Chú ý**:
- `ti` (*task instance*) là tham số giả, chỉ có chức năng hợp thức hóa các phương thức của Xcom, bạn không cần định nghĩa `ti` theo cú pháp gì đặc biệt.
- Task `B` buộc phải đứng sau task `A`. Và `python_callable` của task `B` không cần khai báo các tham số sẽ pull từ Xcom.

VD:
```python
# Pusher
def get_name(ti):
	ti.xcom_push(key='first_name', value='Cao')
	ti.xcom_push(key='last_name', value='Bao')


# Puller
def greet(age, ti):
	first_name = ti.xcom_pull(task_ids='get_name', key='first_name')
	last_name = ti.xcom_pull(task_ids='get_name', key='last_name')
	
	print(f'Hello {first_name} {last_name}. You are {age} years old!')


# DAG defination
# with ...:
	get_name = PythonOperator(task_id='get_name', python_callable=get_name, op_kwargs={'age': 18})
	greet = PythonOperator(task_id='greet', python_callable=greet, op_kwargs={'age': 18})
	
	get_name >> greet
```












